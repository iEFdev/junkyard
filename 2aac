#!/usr/bin/env bash
#
# /usr/local/xbin/2aac
#
# ffmpeg -i "<input>" -c:a libfdk_aac -b:a 320k  -metadata title="<title>" "<output>"
#

ERR=0;
_base=$(basename $0);

[[ ! `type ffmpeg 2> /dev/null` ]] && echo "${_base}: Please install 'ffmpeg'..." && exit 1;

while getopts ":q:" opt; do
    case $opt in
        q)  kbps=$OPTARG; shift $(($OPTIND-1)); ;;
        *)  shift $(($OPTIND));                 ;;
    esac
done

# Make sure '-q' is an integer, or set to default (320)
[[ ${kbps} =~ ^[0-9]+$ ]] || kbps='320'

for file in "$@"; do
    [ ! -f "${file}" ] && echo "${_base}: \"${file}\" doesn't exist" && exit 1;
    [[ ${file##*.} == 'm4a' ]] && echo "${_base}: \"${file}\" is already an m4a file" && exit 1;
    ffmpeg -i "${file}" -vn -c:a libfdk_aac -b:a ${kbps}k \
        -metadata title="$(echo $(basename "${file%.*}") | sed 's/_/ /g')" \
        $(echo "${file%.*}.m4a" | sed 's/[[:space:]]/_/g');
    ERR=$?;
done

exit ${ERR};
